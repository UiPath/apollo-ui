/**
 * Generate theme CSS with body.light/body.dark selectors
 *
 * This script generates proper theme switching CSS by reading apollo-core's
 * SCSS theme definitions and creating CSS with body class selectors.
 *
 * Why we need this:
 * - apollo-core's variables.css only has :root (no theme switching)
 * - apollo-core's theme.scss has semantic color values for all 4 themes
 * - portal-shell uses body.light/body.dark/body.light-hc/body.dark-hc classes
 * - We need CSS variables to update when body class changes
 *
 * Usage: yarn generate:theme-selectors
 */

import * as fs from 'node:fs';
import * as path from 'node:path';

const APOLLO_CORE_PATH = path.resolve(__dirname, '../../../apollo-core/src');

// Apollo semantic colors that need theme-specific values
const SEMANTIC_COLORS = [
  'color-background',
  'color-background-secondary',
  'color-background-inverse',
  'color-background-gray',
  'color-background-disabled',
  'color-background-highlight',
  'color-background-raised',
  'color-background-edit',
  'color-background-gray-emp',
  'color-background-hover',
  'color-background-pressed',
  'color-background-selected',
  'color-selection-indicator',
  'color-notification-badge',
  'color-notification-indicator',
  'color-hover',
  'color-curtain',
  'color-border',
  'color-border-disabled',
  'color-border-grid',
  'color-border-de-emp',
  'color-selection',
  'color-logo',
  'color-foreground',
  'color-foreground-light',
  'color-foreground-emp',
  'color-foreground-de-emp',
  'color-foreground-disable',
  'color-foreground-inverse',
  'color-foreground-highlight',
  'color-foreground-highlight-selected',
  'color-foreground-highlight-selected-hover',
  'color-foreground-link',
  'color-foreground-link-pressed',
  'color-foreground-inv-de-emp',
  'color-primary',
  'color-primary-lighter',
  'color-primary-darker',
  'color-primary-hover',
  'color-primary-focused',
  'color-primary-pressed',
  'color-secondary-focused',
  'color-secondary-pressed',
  'color-chip-default-background',
  'color-chip-error-background',
  'color-chip-warning-background',
  'color-chip-info-background',
  'color-chip-success-background',
  'color-error-icon',
  'color-error-icon-inverse',
  'color-error-text',
  'color-error-background',
  'color-error-foreground-inverse',
  'color-info-foreground',
  'color-info-icon',
  'color-info-icon-inverse',
  'color-info-text',
  'color-info-foreground-inverse',
  'color-info-background',
  'color-success-icon',
  'color-success-icon-inverse',
  'color-success-text',
  'color-success-background',
  'color-success-foreground-inverse',
  'color-warning-icon',
  'color-warning-icon-inverse',
  'color-warning-text',
  'color-warning-background',
  'color-warning-foreground-inverse',
  'color-icon-default',
  'color-icon-inverted-default',
  'color-toggle-off-hover',
  'color-toggle-off-focus',
  'color-toggle-off-pressed',
  'color-toggle-on-hover',
  'color-toggle-on-focus',
  'color-toggle-on-pressed',
  'color-callout-background',
  'color-warn',
  'color-warn-darker',
  'color-warn-hover',
  'color-warn-focus',
  'color-warn-pressed',
  'color-carousel-background',
  'color-icon-button-hover',
  'color-icon-button-focus',
  'color-icon-button-pressed',
  'color-code-function',
  'color-code-operator',
  'color-code-numeric',
  'color-code-text',
  'color-toggle-thumb-off',
  'color-toggle-track-off',
  'color-toggle-thumb-on',
  'color-toggle-track-on',
  'color-toggle-thumb-off-disabled',
  'color-toggle-track-off-disabled',
  'color-toggle-thumb-on-disabled',
  'color-toggle-track-on-disabled',
  'color-skeleton',
  'color-skeleton-glow',
  'color-data-grid-hover',
  'color-data-grid-pressed',
  'color-focus-indicator',
  'color-focus-indicator-inverse',
  'color-chart-purple',
  'color-chart-pink',
  'color-chart-blue-secondary',
  'color-chart-light-blue',
  'color-chart-green',
  'color-chart-yellow',
];

interface ThemeValues {
  [colorName: string]: string;
}

/**
 * Parse SCSS theme map into JavaScript object
 */
function parseThemeMap(content: string, themeName: string): ThemeValues {
  const themeValues: ThemeValues = {};
  
  const themeStart = content.indexOf(`$${themeName}: (`);
  if (themeStart === -1) {
    throw new Error(`Theme "${themeName}" not found`);
  }

  let depth = 0;
  let startIndex = themeStart + `$${themeName}: (`.length;
  let endIndex = startIndex;

  for (let i = startIndex; i < content.length; i++) {
    if (content[i] === '(') depth++;
    if (content[i] === ')') {
      if (depth === 0) {
        endIndex = i;
        break;
      }
      depth--;
    }
  }

  const themeBlock = content.substring(startIndex, endIndex);
  const lines = themeBlock.split('\n');
  
  for (const line of lines) {
    const trimmed = line.trim();
    const match = trimmed.match(/^([\w-]+):\s*\$([\w-]+),?$/);
    if (match) {
      const [, colorName, variableName] = match;
      if (SEMANTIC_COLORS.includes(colorName)) {
        themeValues[colorName] = variableName;
      }
    }
  }

  return themeValues;
}

/**
 * Resolve SCSS variable to hex value
 */
function resolveVariable(variableName: string, variablesContent: string): string {
  const regex = new RegExp(`\\$${variableName}:\\s*([^;]+);`);
  const match = variablesContent.match(regex);
  
  if (!match) {
    throw new Error(`Variable "${variableName}" not found`);
  }
  
  return match[1].trim();
}

/**
 * Generate CSS for a single theme
 */
function generateThemeCSS(
  selector: string,
  themeValues: ThemeValues,
  variablesContent: string
): string {
  const lines: string[] = [`${selector} {`];
  const sortedColors = Object.keys(themeValues).sort();

  for (const colorName of sortedColors) {
    const variableName = themeValues[colorName];
    try {
      const value = resolveVariable(variableName, variablesContent);
      lines.push(`  --${colorName}: ${value};`);
    } catch (error) {
      console.warn(`Warning: Could not resolve ${colorName}`);
    }
  }

  lines.push('}');
  return lines.join('\n');
}

/**
 * Main generation function
 */
function main() {
  console.log('ðŸŽ¨ Generating theme CSS with body selectors...');

  const themePath = path.join(APOLLO_CORE_PATH, 'scss/theme.scss');
  const variablesPath = path.join(APOLLO_CORE_PATH, 'scss/variables.scss');

  const themeContent = fs.readFileSync(themePath, 'utf-8');
  const variablesContent = fs.readFileSync(variablesPath, 'utf-8');

  // Parse all 4 themes
  const themes = {
    light: parseThemeMap(themeContent, 'light'),
    dark: parseThemeMap(themeContent, 'dark'),
    'light-hc': parseThemeMap(themeContent, 'light-hc'),
    'dark-hc': parseThemeMap(themeContent, 'dark-hc'),
  };

  // Generate CSS
  const css: string[] = [];
  
  css.push('/**');
  css.push(' * Apollo Design System Theme Variables');
  css.push(' * ');
  css.push(' * Auto-generated from apollo-core SCSS theme definitions.');
  css.push(' * Do not edit manually - run `yarn generate:theme-selectors` to regenerate.');
  css.push(' * ');
  css.push(' * Theme switching via body class:');
  css.push(' * - body.light       - Standard light theme');
  css.push(' * - body.dark        - Standard dark theme');
  css.push(' * - body.light-hc    - High contrast light theme');
  css.push(' * - body.dark-hc     - High contrast dark theme');
  css.push(' */');
  css.push('');

  // Generate selectors for each theme
  css.push(generateThemeCSS('body.light', themes.light, variablesContent));
  css.push('');
  css.push(generateThemeCSS('body.dark', themes.dark, variablesContent));
  css.push('');
  css.push(generateThemeCSS('body.light-hc', themes['light-hc'], variablesContent));
  css.push('');
  css.push(generateThemeCSS('body.dark-hc', themes['dark-hc'], variablesContent));
  css.push('');

  // Default theme as fallback
  css.push('/* Default theme (light) as fallback */');
  css.push(generateThemeCSS(':root', themes.light, variablesContent));

  const outputPath = path.resolve(__dirname, '../src/theme-selectors.css');
  fs.writeFileSync(outputPath, css.join('\n'), 'utf-8');

  const sizeKB = (Buffer.byteLength(css.join('\n'), 'utf-8') / 1024).toFixed(2);
  
  console.log('âœ… Theme CSS generated:');
  console.log(`   File: src/theme-selectors.css`);
  console.log(`   Size: ${sizeKB} KB`);
  console.log(`   Themes: light, dark, light-hc, dark-hc`);
  console.log(`   Colors: ${SEMANTIC_COLORS.length} semantic colors`);
}

if (import.meta.url === `file://${process.argv[1]}`) {
  main();
}

export { main as generateThemeSelectors };
