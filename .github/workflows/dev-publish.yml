name: Dev Publish

permissions:
  contents: read
  pull-requests: read

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

env:
  GH_NPM_REGISTRY_TOKEN: ${{ secrets.GH_NPM_REGISTRY_TOKEN }}
  NPM_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
  TURBO_TELEMETRY_DISABLED: 1
  DO_NOT_TRACK: 1

concurrency:
  group: dev-publish-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  detect-changes:
    name: Detect Changed Packages
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.changed.outputs.packages }}
      has_changes: ${{ steps.changed.outputs.has_changes }}
      matrix: ${{ steps.matrix.outputs.matrix }}
      has_previous: ${{ steps.previous.outputs.has_previous }}
      previous_packages: ${{ steps.previous.outputs.packages }}
      previous_matrix: ${{ steps.previous-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Check for previous versions
        id: previous
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          COMMENT=$(gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq '[.[] | select(.body | contains("<!-- dev-packages-comment -->")) | .body][0]' 2>/dev/null) || true

          if [ -z "$COMMENT" ]; then
            echo "has_previous=false" >> $GITHUB_OUTPUT
            echo "packages=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract all package@version from comment (table format)
          # Matches: | `@uipath/package@version-pr123.sha` | status | timestamp |
          PUBLISHED=$(echo "$COMMENT" | grep -oE '\| `@uipath/[a-z0-9-]+@[0-9.]+-pr[0-9]+(\.[a-z0-9]+)?`' | sed 's/^| `//' | sed 's/`$//' | sort -u)

          if [ -z "$PUBLISHED" ]; then
            echo "has_previous=false" >> $GITHUB_OUTPUT
            echo "packages=" >> $GITHUB_OUTPUT
          else
            echo "has_previous=true" >> $GITHUB_OUTPUT
            echo "packages<<EOF" >> $GITHUB_OUTPUT
            echo "$PUBLISHED" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "Found previous versions: $PUBLISHED"
          fi

      - name: Create previous packages matrix
        id: previous-matrix
        if: steps.previous.outputs.has_previous == 'true'
        env:
          PACKAGES: ${{ steps.previous.outputs.packages }}
        run: |
          # Convert newline-separated package@version list to JSON array
          # Use -Rsc: Raw input, Slurp mode, Compact output (single line)
          MATRIX_JSON=$(echo "$PACKAGES" | jq -Rsc 'split("\n") | map(select(length > 0))')
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          echo "Previous matrix: $MATRIX_JSON"

      - name: Get changed packages
        id: changed
        run: |
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          PACKAGES=""

          for pkg_dir in packages/* web-packages/*; do
            if [ -f "$pkg_dir/package.json" ]; then
              pkg_folder=$(basename "$pkg_dir")
              parent_folder=$(dirname "$pkg_dir")
              if echo "$CHANGED_FILES" | grep -q "^${parent_folder}/${pkg_folder}/"; then
                name=$(jq -r '.name' "$pkg_dir/package.json")
                if ! [[ "$name" =~ ^@uipath/[a-z0-9-]+$ ]]; then
                  echo "::warning::Skipping invalid package name: $name"
                  continue
                fi
                PACKAGES="$PACKAGES $name"
              fi
            fi
          done

          PACKAGES=$(echo "$PACKAGES" | xargs)
          if [ -z "$PACKAGES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "packages=" >> $GITHUB_OUTPUT
          else
            echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
          echo "Changed packages: $PACKAGES"

      - name: Create matrix
        id: matrix
        if: steps.changed.outputs.has_changes == 'true'
        run: |
          # Convert space-separated list to compact JSON array
          PACKAGES="${{ steps.changed.outputs.packages }}"
          MATRIX_JSON=$(echo "$PACKAGES" | jq -Rc 'split(" ") | map(select(length > 0))')
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          echo "Matrix: $MATRIX_JSON"

  cleanup:
    name: Cleanup ${{ matrix.package_version }}
    needs: detect-changes
    if: needs.detect-changes.outputs.has_previous == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package_version: ${{ fromJSON(needs.detect-changes.outputs.previous_matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cleanup previous version
        env:
          PACKAGE_VERSION: ${{ matrix.package_version }}
        run: |
          if ! [[ "$PACKAGE_VERSION" =~ ^@uipath/[a-z0-9-]+@[0-9.]+-pr[0-9]+(\.[a-z0-9]+)?$ ]]; then
            echo "::error::Invalid package version format: $PACKAGE_VERSION"
            exit 1
          fi

          pkg_name="${PACKAGE_VERSION%@*}"
          version="${PACKAGE_VERSION##*@}"

          echo "Cleaning up: $PACKAGE_VERSION"
          pnpm unpublish:dev "$pkg_name" "$version"

  update-comment-publishing:
    name: Update Comment - Publishing
    needs: [detect-changes, cleanup]
    if: always() && needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Create initial PR comment
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PACKAGES: ${{ needs.detect-changes.outputs.packages }}
          SHORT_SHA: ${{ github.sha }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SHORT_SHA="${SHORT_SHA:0:7}"
          pnpm exec tsx scripts/create-dev-comment.ts

  publish:
    name: Publish ${{ matrix.package }}
    needs: [detect-changes, cleanup, update-comment-publishing]
    if: always() && needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    strategy:
      fail-fast: false # Continue even if one package fails
      matrix:
        package: ${{ fromJSON(needs.detect-changes.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build package
        env:
          PACKAGE: ${{ matrix.package }}
        run: pnpm build --filter="$PACKAGE"

      - name: Publish package
        id: publish
        env:
          PACKAGE: ${{ matrix.package }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          SHORT_SHA="${GITHUB_SHA:0:7}"
          SUFFIX="pr${PR_NUMBER}.${SHORT_SHA}"

          echo "Publishing $PACKAGE with suffix $SUFFIX..."
          pkg_json=$(find packages web-packages -name package.json -exec grep -l "\"name\": \"$PACKAGE\"" {} \; | head -1)
          version=$(jq -r '.version' "$pkg_json" 2>/dev/null || echo "unknown")

          if pnpm publish:dev "$PACKAGE" "$SUFFIX"; then
            echo "full_version=$PACKAGE@$version-$SUFFIX" >> $GITHUB_OUTPUT
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "full_version=$PACKAGE@$version-$SUFFIX" >> $GITHUB_OUTPUT
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Update PR comment row
        if: always()
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          FULL_VERSION: ${{ steps.publish.outputs.full_version }}
          PUBLISH_STATUS: ${{ steps.publish.outputs.status }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: pnpm exec tsx scripts/update-dev-comment-row.ts

