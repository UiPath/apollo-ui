name: Dev Publish

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

env:
  GH_NPM_REGISTRY_TOKEN: ${{ secrets.GH_NPM_REGISTRY_TOKEN }}
  TURBO_TELEMETRY_DISABLED: 1
  DO_NOT_TRACK: 1

concurrency:
  group: dev-publish-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  dev-publish:
    name: Dev Publish
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Check for existing dev packages comment
        id: existing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          COMMENT=$(gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq '[.[] | select(.body | startswith("## ðŸ“¦ Dev Packages")) | .body][0]' 2>/dev/null) || true

          if [ -z "$COMMENT" ]; then
            echo "No existing dev packages comment found"
            echo "has_comment=false" >> $GITHUB_OUTPUT
            echo "has_published=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_comment=true" >> $GITHUB_OUTPUT

          # Extract package@version from ðŸŸ¢ Published lines
          PUBLISHED=$(echo "$COMMENT" | grep -oE '`@uipath/[a-z0-9-]+@[0-9.]+-pr[0-9]+`' | tr -d '`' | sort -u)

          if [ -z "$PUBLISHED" ]; then
            echo "No previously published packages in comment"
            echo "has_published=false" >> $GITHUB_OUTPUT
          else
            echo "has_published=true" >> $GITHUB_OUTPUT
            echo "published<<EOF" >> $GITHUB_OUTPUT
            echo "$PUBLISHED" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "Found published packages: $PUBLISHED"
          fi

      - name: Get changed packages
        id: changed
        run: |
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          PACKAGES=""

          for pkg_dir in packages/* web-packages/*; do
            if [ -f "$pkg_dir/package.json" ]; then
              pkg_folder=$(basename "$pkg_dir")
              parent_folder=$(dirname "$pkg_dir")
              if echo "$CHANGED_FILES" | grep -q "^${parent_folder}/${pkg_folder}/"; then
                name=$(jq -r '.name' "$pkg_dir/package.json")
                # Validate package name format to prevent shell injection
                if ! [[ "$name" =~ ^@uipath/[a-z0-9-]+$ ]]; then
                  echo "::warning::Skipping invalid package name: $name"
                  continue
                fi
                # Skip angular (excluded from release)
                if [ "$name" != "@uipath/apollo-angular" ]; then
                  PACKAGES="$PACKAGES $name"
                fi
              fi
            fi
          done

          PACKAGES=$(echo "$PACKAGES" | xargs)
          if [ -z "$PACKAGES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
          echo "Changed packages: $PACKAGES"

      - name: Setup pnpm
        if: steps.changed.outputs.has_changes == 'true' || steps.existing.outputs.has_published == 'true'
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4

      - name: Setup Node.js
        if: steps.changed.outputs.has_changes == 'true' || steps.existing.outputs.has_published == 'true'
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: 'pnpm'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@uipath'

      - name: Install dependencies
        if: steps.changed.outputs.has_changes == 'true' || steps.existing.outputs.has_published == 'true'
        run: pnpm install --frozen-lockfile

      - name: Cleanup previous dev packages
        if: steps.existing.outputs.has_published == 'true'
        env:
          GH_NPM_REGISTRY_TOKEN: ${{ secrets.GH_NPM_REGISTRY_TOKEN }}
          PUBLISHED: ${{ steps.existing.outputs.published }}
        run: |
          echo "Cleaning up previous dev packages:"
          echo "$PUBLISHED" | while IFS= read -r pkg_version; do
            [ -z "$pkg_version" ] && continue
            # Validate format for defense in depth
            if ! [[ "$pkg_version" =~ ^@uipath/[a-z0-9-]+@[0-9.]+-pr[0-9]+$ ]]; then
              echo "::warning::Skipping invalid package version: $pkg_version"
              continue
            fi
            pkg_name="${pkg_version%@*}"
            version="${pkg_version##*@}"
            echo "  Unpublishing $pkg_name@$version..."
            pnpm unpublish:dev "$pkg_name" "$version" 2>/dev/null || true
          done

      - name: Delete comment (no packages to publish)
        if: steps.changed.outputs.has_changes != 'true' && steps.existing.outputs.has_comment == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          COMMENT_ID=$(gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq '.[] | select(.body | startswith("## ðŸ“¦ Dev Packages")) | .id' | head -1) || true

          if [ -n "$COMMENT_ID" ]; then
            echo "Deleting dev packages comment (no packages to publish)..."
            gh api -X DELETE "repos/${{ github.repository }}/issues/comments/${COMMENT_ID}"
          fi

      - name: Update PR comment (publishing)
        if: steps.changed.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PACKAGES: ${{ steps.changed.outputs.packages }}
        run: |
          TIMESTAMP=$(TZ="America/Los_Angeles" date "+%Y-%m-%d %H:%M:%S PT")
          COMMENT_BODY="## ðŸ“¦ Dev Packages"$'\n\n'

          for name in $PACKAGES; do
            pkg_json=$(find packages web-packages -name package.json -exec grep -l "\"name\": \"$name\"" {} \; | head -1 || true)
            if [ -n "$pkg_json" ] && [ -f "$pkg_json" ]; then
              version=$(jq -r '.version // empty' "$pkg_json" 2>/dev/null || true)
              if [ -n "$version" ]; then
                COMMENT_BODY+="ðŸŸ¡ Publishing... \`${name}@${version}-pr${PR_NUMBER}\`"$'\n'
              else
                COMMENT_BODY+="ðŸ”´ Error: Could not read version for \`${name}\`"$'\n'
              fi
            else
              COMMENT_BODY+="ðŸ”´ Error: Could not find package.json for \`${name}\`"$'\n'
            fi
          done

          COMMENT_BODY+=$'\n'"**Last updated:** ${TIMESTAMP}"

          COMMENT_ID=$(gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq '.[] | select(.body | startswith("## ðŸ“¦ Dev Packages")) | .id' | head -1) || true

          if [ -n "$COMMENT_ID" ]; then
            gh api "repos/${{ github.repository }}/issues/comments/${COMMENT_ID}" -X PATCH -f body="$COMMENT_BODY"
          else
            gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" -f body="$COMMENT_BODY"
          fi

      - name: Build all packages
        if: steps.changed.outputs.has_changes == 'true'
        run: pnpm build

      - name: Publish dev packages
        if: steps.changed.outputs.has_changes == 'true'
        id: publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GH_NPM_REGISTRY_TOKEN }}
          NPM_TOKEN: ${{ secrets.GH_NPM_REGISTRY_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PACKAGES: ${{ steps.changed.outputs.packages }}
        run: |
          RESULTS=""
          SUFFIX="pr${PR_NUMBER}"

          for name in $PACKAGES; do
            echo "::group::Publishing $name"

            if pnpm publish:dev "$name" "$SUFFIX"; then
              pkg_json=$(find packages web-packages -name package.json -exec grep -l "\"name\": \"$name\"" {} \; | head -1)
              version=$(jq -r '.version' "$pkg_json" 2>/dev/null || echo "unknown")
              RESULTS="${RESULTS}${name}@${version}-${SUFFIX}:success"$'\n'
            else
              RESULTS="${RESULTS}${name}:error"$'\n'
            fi

            echo "::endgroup::"
          done

          # Use heredoc for multiline output
          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update PR comment (final)
        if: steps.changed.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          RESULTS: ${{ steps.publish.outputs.results }}
        run: |
          TIMESTAMP=$(TZ="America/Los_Angeles" date "+%Y-%m-%d %H:%M:%S PT")
          COMMENT_BODY="## ðŸ“¦ Dev Packages"$'\n\n'

          while IFS= read -r result; do
            [ -z "$result" ] && continue
            pkg="${result%:*}"
            status="${result##*:}"
            # Validate format for defense in depth
            if ! [[ "$pkg" =~ ^@uipath/[a-z0-9-]+(@[0-9.]+-pr[0-9]+)?$ ]]; then
              echo "::warning::Skipping invalid result: $result"
              continue
            fi
            if [ "$status" = "success" ]; then
              COMMENT_BODY+="ðŸŸ¢ Published \`${pkg}\`"$'\n'
            else
              COMMENT_BODY+="ðŸ”´ Error publishing \`${pkg}\`"$'\n'
            fi
          done <<< "$RESULTS"

          COMMENT_BODY+=$'\n'"**Last updated:** ${TIMESTAMP}"

          COMMENT_ID=$(gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq '.[] | select(.body | startswith("## ðŸ“¦ Dev Packages")) | .id' | head -1) || true

          if [ -n "$COMMENT_ID" ]; then
            gh api "repos/${{ github.repository }}/issues/comments/${COMMENT_ID}" -X PATCH -f body="$COMMENT_BODY"
          else
            gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" -f body="$COMMENT_BODY"
          fi
