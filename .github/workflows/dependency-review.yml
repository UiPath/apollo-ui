name: Dependency Review

on: [pull_request]

permissions:
  contents: read
  pull-requests: write

jobs:
  dependency-review:
    name: Dependencies license check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22

      - name: Generate UiPath-approved license allowlist
        id: licenses
        shell: bash
        # Source: https://uipath.atlassian.net/wiki/spaces/LEG/pages/2861433455/FOSS+license+standard (GO section)
        run: |
          ALLOW="$(npx -y tsx scripts/allowed-licenses.ts)"
          echo "allow=$ALLOW" >> "$GITHUB_OUTPUT"

      - name: Dependency Review
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4
        with:
          fail-on-severity: high
          allow-licenses: ${{ steps.licenses.outputs.allow }}
          comment-summary-in-pr: always
