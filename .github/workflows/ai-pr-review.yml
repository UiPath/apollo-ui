name: AI PR Review

# ‚ö†Ô∏è TEMPORARY SOLUTION - REMOVE WHEN TEAM GROWS
# This workflow uses Claude AI to review and approve PRs automatically.
# This is a stopgap measure for solo development to avoid bypassing reviews entirely.
# Once there are multiple contributors, this workflow should be DISABLED and replaced
# with human code reviews for proper quality and security oversight.

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  contents: read
  pull-requests: write

env:
  TURBO_TELEMETRY_DISABLED: 1

jobs:
  ai-review:
    name: Claude AI Code Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          DIFF=$(git diff origin/${{ github.event.pull_request.base.ref }}...${{ github.event.pull_request.head.sha }})
          # Truncate diff to avoid API limits (max ~100k characters)
          DIFF_TRUNCATED=$(echo "$DIFF" | head -c 100000)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF_TRUNCATED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get PR metadata
        id: pr-info
        run: |
          echo "title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
          echo "description<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.pull_request.body }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check if author has admin/write permissions
        id: check-permissions
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const author = context.payload.pull_request.user.login;
            try {
              const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: author
              });
              const hasPermission = ['admin', 'write'].includes(permission.permission);
              console.log(`Author ${author} has permission: ${permission.permission}`);
              return hasPermission;
            } catch (error) {
              console.log(`Could not check permissions for ${author}: ${error.message}`);
              return false;
            }

      - name: Review with Claude API
        id: claude-review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Create the review prompt
          cat > review_prompt.txt << 'PROMPT_EOF'
          You are a senior code reviewer for the Apollo UI project - a multi-framework design system for UiPath.

          Review this pull request and provide:
          1. **Summary**: Brief overview of changes
          2. **Code Quality**: Critical issues with code structure, patterns, or best practices
          3. **Security**: Any security concerns (XSS, injection, secrets exposure, etc.)
          4. **Type Safety**: TypeScript errors or type issues
          5. **Testing**: Missing tests or test coverage concerns
          6. **Performance**: Performance implications
          7. **Recommendation**: APPROVE or REQUEST_CHANGES

          Focus on blocking issues that prevent merging. Minor style/formatting issues are acceptable.
          For workflow/infrastructure changes, prioritize correctness over style.
          APPROVE if the changes are functionally correct and secure, even if style could be improved.

          PR Title: ${{ steps.pr-info.outputs.title }}

          PR Description:
          ${{ steps.pr-info.outputs.description }}

          Code Changes:
          ```diff
          ${{ steps.diff.outputs.diff }}
          ```

          Provide your review in markdown format.
          PROMPT_EOF

          # Call Claude API
          REVIEW_RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d @- << EOF
          {
            "model": "claude-sonnet-4-20250514",
            "max_tokens": 4096,
            "messages": [
              {
                "role": "user",
                "content": $(cat review_prompt.txt | jq -Rs .)
              }
            ]
          }
          EOF
          )

          # Extract review text
          REVIEW_TEXT=$(echo "$REVIEW_RESPONSE" | jq -r '.content[0].text // "Error: No review generated"')

          # Save to output
          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_TEXT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Determine if we should approve (look for "APPROVE" in recommendation section)
          if echo "$REVIEW_TEXT" | grep -Pzo "(?s)Recommendation.*?APPROVE" > /dev/null 2>&1 || \
             echo "$REVIEW_TEXT" | grep -iq "Recommendation.*APPROVE" || \
             (echo "$REVIEW_TEXT" | grep -iq "Recommendation" && echo "$REVIEW_TEXT" | grep -iq "\*\*APPROVE\*\*"); then
            echo "should_approve=true" >> $GITHUB_OUTPUT
          else
            echo "should_approve=false" >> $GITHUB_OUTPUT
          fi

      - name: Post review comment
        uses: actions/github-script@v7
        env:
          REVIEW_BODY: ${{ steps.claude-review.outputs.review }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const reviewBody = process.env.REVIEW_BODY;
            const header = '## ü§ñ AI Code Review (Claude)\n\n‚ö†Ô∏è **Automated Review**: This is an AI-generated review. Use as guidance, not gospel.\n\n';
            const footer = '\n\n---\n*This automated review is temporary for solo development. Will be replaced with human reviews once the team grows.*';
            const review = header + reviewBody + footer;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: review
            });

      - name: Approve PR if safe and author has write/admin permissions
        if: steps.claude-review.outputs.should_approve == 'true' && steps.check-permissions.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE',
              body: '‚úÖ AI Review: Changes look good. Auto-approved by Claude AI.'
            });

      - name: Request changes if issues found
        if: steps.claude-review.outputs.should_approve != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'COMMENT',
              body: '‚ö†Ô∏è AI Review: Please review the concerns raised above before merging.'
            });
