name: Cleanup Old Dev Packages

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:  # Allow manual trigger

env:
  GH_NPM_REGISTRY_TOKEN: ${{ secrets.GH_NPM_REGISTRY_TOKEN }}
  NPM_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}

permissions:
  contents: read

jobs:
  cleanup:
    name: Cleanup Dev Packages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: main

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cleanup dev versions
        run: |
          echo "Finding dev-tagged versions for all packages..."
          echo ""

          # Dynamically discover all packages from the monorepo
          PACKAGES=$(find packages web-packages -maxdepth 2 -name package.json -exec jq -r '.name' {} \; | grep -E '^@uipath/' | sort -u)

          echo "Discovered packages:"
          echo "$PACKAGES"
          echo ""

          for package in $PACKAGES; do
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "Checking: $package"

            # Get all dev versions (matching PR pattern)
            # Use registry API directly since npm view doesn't show prerelease versions
            ENCODED_PKG=$(echo "$package" | sed 's/@/%40/g' | sed 's/\//%2F/g')
            DEV_VERSIONS=$(curl -s "https://registry.npmjs.org/$ENCODED_PKG" 2>/dev/null | \
              jq -r '.versions | keys[]' | grep -E '\-pr[0-9]+(\.[a-z0-9]+)?$' || true)

            if [ -z "$DEV_VERSIONS" ]; then
              echo "  No dev versions found"
              continue
            fi

            echo "  Found $(echo "$DEV_VERSIONS" | wc -l) dev versions"
            CLEANED=0

            # Only unpublish packages that are already deprecated
            while IFS= read -r version; do
              [ -z "$version" ] && continue

              # Extract just the version part (remove package name if present)
              version="${version##*@}"

              # Check if package version is deprecated via registry API
              # URL-encode the package name for scoped packages
              ENCODED_PKG=$(echo "$package" | sed 's/@/%40/g' | sed 's/\//%2F/g')
              DEPRECATED_MSG=$(curl -s "https://registry.npmjs.org/$ENCODED_PKG/$version" 2>/dev/null | jq -r 'if type == "object" then .deprecated // empty else empty end' 2>/dev/null || echo "")

              if [ -n "$DEPRECATED_MSG" ] && [ "$DEPRECATED_MSG" != "null" ]; then
                echo "  Found deprecated: $package@$version"
                echo "  Attempting unpublish..."
                if pnpm unpublish:dev "$package" "$version" 2>&1 | grep -q "successfully\|Already removed"; then
                  CLEANED=$((CLEANED + 1))
                  echo "    ✓ Unpublished"
                else
                  echo "    ✗ Failed (likely >72h old, remains deprecated)"
                fi
              else
                echo "  Skipping $package@$version (not deprecated)"
              fi
            done <<< "$DEV_VERSIONS"

            echo "  Cleaned up: $CLEANED versions"
            echo ""
          done

          echo "Cleanup complete"
