name: Dev Cleanup

on:
  pull_request:
    types: [closed]
    branches:
      - main

env:
  GH_NPM_REGISTRY_TOKEN: ${{ secrets.GH_NPM_REGISTRY_TOKEN }}
  NPM_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
  TURBO_TELEMETRY_DISABLED: 1
  DO_NOT_TRACK: 1

jobs:
  cleanup:
    name: Cleanup Dev Packages
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: main

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Get published packages from PR comment
        id: packages
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          COMMENT=$(gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq '[.[] | select(.body | contains("<!-- dev-packages-comment -->")) | .body][0]' 2>/dev/null) || true

          if [ -z "$COMMENT" ]; then
            echo "No dev packages comment found"
            echo "packages=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract package@version from table format (supports pr123 and pr123.abc1234 formats)
          # Matches: | `@uipath/package@version-pr123.sha` | status | timestamp |
          PACKAGES=$(echo "$COMMENT" | grep -oE '\| `@uipath/[a-z0-9-]+@[0-9.]+-pr[0-9]+(\.[a-z0-9]+)?`' | sed 's/^| `//' | sed 's/`$//' | sort -u)
          # Use delimiter for GitHub output (newlines not supported)
          echo "packages<<EOF" >> $GITHUB_OUTPUT
          echo "$PACKAGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Found: $PACKAGES"

      - name: Cleanup dev packages
        if: steps.packages.outputs.packages != ''
        env:
          PACKAGES: ${{ steps.packages.outputs.packages }}
        run: |
          echo "Cleaning up dev packages..."
          echo ""

          while IFS= read -r pkg_version; do
            [ -z "$pkg_version" ] && continue

            # Validate format for defense in depth (supports pr123 and pr123.abc1234)
            if ! [[ "$pkg_version" =~ ^@uipath/[a-z0-9-]+@[0-9.]+-pr[0-9]+(\.[a-z0-9]+)?$ ]]; then
              echo "::warning::Skipping invalid package version: $pkg_version"
              continue
            fi

            pkg_name="${pkg_version%@*}"
            version="${pkg_version##*@}"

            echo "Cleaning up $pkg_name@$version..."
            if pnpm unpublish:dev "$pkg_name" "$version"; then
              echo "  ‚úì Cleaned up"
            else
              echo "  ‚úó Could not clean up"
            fi
          done <<< "$PACKAGES"

          echo ""
          echo "Cleanup complete"

      - name: Update PR comment
        if: steps.packages.outputs.packages != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set +e  # Don't exit on error, but capture it
          set -o pipefail  # Capture exit code from gh api, not head
          COMMENT_ID=$(gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq '([.[] | select(.body | contains("<!-- dev-packages-comment -->")) | .id][0] // empty)' 2>&1)
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -ne 0 ]; then
            echo "‚ö†Ô∏è Could not fetch comment (PR may be inaccessible)"
            echo "$COMMENT_ID"
            exit 0  # Non-fatal, comment update is optional
          fi

          if [ -n "$COMMENT_ID" ]; then
            TIMESTAMP=$(TZ="America/Los_Angeles" date "+%Y-%m-%d %H:%M:%S PT")
            COMMENT_BODY="<!-- dev-packages-comment -->"$'\n\n'
            COMMENT_BODY+="## üì¶ Dev Packages"$'\n\n'
            COMMENT_BODY+="üßπ Dev packages cleaned up after PR close."$'\n\n'
            COMMENT_BODY+="**Last updated:** ${TIMESTAMP}"

            if ! gh api "repos/${{ github.repository }}/issues/comments/${COMMENT_ID}" \
              -X PATCH -f body="$COMMENT_BODY" 2>&1; then
              echo "‚ö†Ô∏è Could not update comment (non-fatal)"
            else
              echo "‚úì Updated cleanup status in PR comment"
            fi
          else
            echo "No comment found to update"
          fi
