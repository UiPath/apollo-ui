name: Dev Cleanup

on:
  pull_request:
    types: [closed]
    branches:
      - main

env:
  TURBO_TELEMETRY_DISABLED: 1
  DO_NOT_TRACK: 1

jobs:
  cleanup:
    name: Cleanup Dev Packages
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      packages: write

    steps:
      - name: Get published packages from PR comment
        id: packages
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          COMMENT=$(gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq '[.[] | select(.body | startswith("## ðŸ“¦ Dev Packages")) | .body][0]' 2>/dev/null) || true

          if [ -z "$COMMENT" ]; then
            echo "No dev packages comment found"
            echo "packages=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract package@version from within backticks (e.g., `@uipath/apollo-core@5.6.0-pr123`)
          # Store newline-separated for safer iteration
          PACKAGES=$(echo "$COMMENT" | grep -oE '`@uipath/[a-z0-9-]+@[0-9.]+-pr[0-9]+`' | tr -d '`' | sort -u)
          # Use delimiter for GitHub output (newlines not supported)
          echo "packages<<EOF" >> $GITHUB_OUTPUT
          echo "$PACKAGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Found: $PACKAGES"

      - name: Cleanup dev packages
        if: steps.packages.outputs.packages != ''
        env:
          NPM_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
          PACKAGES: ${{ steps.packages.outputs.packages }}
        run: |
          echo "âš ï¸  Warning: npm.org doesn't support automated package deletion"
          echo "Dev packages will remain published with -pr suffix"
          echo ""
          echo "The following packages were published but cannot be auto-cleaned:"
          echo "$PACKAGES" | while IFS= read -r pkg_version; do
            [ -z "$pkg_version" ] && continue
            echo "  - $pkg_version"
          done
          echo ""
          echo "Note: npm only allows unpublishing within 72 hours of publication"
          echo "Consider using 'npm deprecate' instead or keeping dev packages on GitHub registry"

      - name: Update PR comment
        if: steps.packages.outputs.packages != ''
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          COMMENT_ID=$(gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq '.[] | select(.body | startswith("## ðŸ“¦ Dev Packages")) | .id' 2>/dev/null | head -1) || true

          if [ -n "$COMMENT_ID" ]; then
            TIMESTAMP=$(TZ="America/Los_Angeles" date "+%Y-%m-%d %H:%M:%S PT")
            COMMENT_BODY="## ðŸ“¦ Dev Packages"$'\n\n'
            COMMENT_BODY+="ðŸ§¹ Dev packages cleaned up after PR close."$'\n\n'
            COMMENT_BODY+="**Last updated:** ${TIMESTAMP}"

            gh api "repos/${{ github.repository }}/issues/comments/${COMMENT_ID}" \
              -X PATCH -f body="$COMMENT_BODY" 2>/dev/null || true
          fi
